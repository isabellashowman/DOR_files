library(readxl)
library(tidyverse)
library(rMR)
# to erase all objects from memory:
# rm(list= ls())

filename <- "~/Library/CloudStorage/OneDrive-Personal/EarthLab Internship/CleanedOxygenThresholds.xlsx"

thedata <- read_excel(filename)

# create new column called p_crit_kpa, which has all p_crit measurements in the same units (kPa)
# drop all rows that do not list units
source("~/Library/CloudStorage/OneDrive-Personal/EarthLab Internship/helper_funs.R") # loads the functions needed to convert ml /l to kPa

thedata <- drop_na(thedata, units)
torr.2.kpa <- 0.13332
thedata$p_crit_kpa <- NA
thedata$p_crit_kpa[thedata$units == "kPa (PO2)"] <- thedata$p_crit[thedata$units == "kPa (PO2)"]
thedata$p_crit_kpa[thedata$units == "Torr"] <- torr.2.kpa * thedata$p_crit[thedata$units == "Torr"]
thedata$p_crit_kpa[thedata$units == "mm Hg"] <- torr.2.kpa * thedata$p_crit[thedata$units == "mm Hg"]



thedata$salinity[thedata$fresh_or_salt=="fresh"] <- 0
thedata$salinity[thedata$fresh_or_salt=="salt"] <- 34.9



mg_l_index <- which(thedata$units == "mg/L")
ml_l_index <- which(thedata$units == "ml/L")



thedata$p_crit_kpa[mg_l_index] <- DO.unit.convert(x = thedata$p_crit[mg_l_index],
                                                  DO.units.in = "mg/L",
                                                  DO.units.out = "PP",
                                                  bar.units.out = "kpa",
                                                  bar.press = 1,
                                                  bar.units.in = "atm",
                                                  salinity = thedata$salinity[mg_l_index],
                                                  salinity.units = "uS",
                                                  temp.C = thedata$temperature_c[mg_l_index])

thedata$p_crit_kpa[ml_l_index] <- DO.unit.convert( x = 1.429 * thedata$p_crit[ml_l_index],
                                                   DO.units.in = "mg/L",
                                                   DO.units.out = "PP",
                                                   bar.units.out = "kpa",
                                                   bar.press = 1,
                                                   bar.units.in = "atm",
                                                   salinity = thedata$salinity[ml_l_index],
                                                   salinity.units = "uS",
                                                   temp.C = thedata$temperature_c[ml_l_index])

pct_index <- which(thedata$units == "% saturation")


thedata$p_crit_kpa[pct_index] <- DO.unit.convert( x = thedata$p_crit[pct_index],
                                                  DO.units.in = "pct",
                                                  DO.units.out = "PP",
                                                  bar.units.out = "kpa",
                                                  bar.press = 1,
                                                  bar.units.in = "atm",
                                                  salinity = thedata$salinity[pct_index],
                                                  salinity.units = "uS",
                                                  temp.C = thedata$temperature_c[pct_index])

#making sure units are being converted properly
summary(thedata$p_crit[mg_l_index])
summary(thedata$salinity[mg_l_index])
summary(thedata$temperature_c[mg_l_index])

View(thedata[mg_l_index[is.na(thedata$p_crit[mg_l_index]) |
                          is.na(thedata$salinity[mg_l_index]) |
                          is.na(thedata$temperature_c[mg_l_index])], ])


summary_by_type_species <- thedata %>%
  group_by(genus, method) %>%
  summarise(number = n())

View(summary_by_type_species)

#Compare species with methodology, p crit with mass, p crit and temperature, 
# species and p crit

summary_by_pcrit_mass_temp <- thedata %>%
  group_by(genus, units, references, temperature_c, p_crit, p_crit_kpa) %>%
  summarise(number = n())

View(summary_by_pcrit_mass_temp)

#scatterplot of temp vs pcrit with colors identifying genus

taxa.2.plot.test <-  thedata %>%
  drop_na(p_crit_kpa)
ggplot(taxa.2.plot.test, aes(x = (temperature_c), y = p_crit_kpa)) +
  geom_point(aes(col = genus)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # trend lines for each color/genus
  labs(
    title ="P_crit vs. Temperature",
    x ="Temperature (°C)",
    y ="Critical Oxygen Threshold (kPa)"
  )

#Plot oxygen consumption method only for each genus
method_plot <-  thedata %>%
  filter(method == "OxygenConsumption") %>%
  drop_na(p_crit_kpa)
ggplot(method_plot, aes(x = temperature_c, y = p_crit_kpa, col = genus)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(size = 3) +
  xlab("Temperature (°C)") +
  ylab("Critical Oxygen (kPa)")

#ONCORHYNCHUS
#Make dataset of combed through data for Oncorhynchus
SalmonData <- thedata %>%
  filter(genus == "Oncorhynchus") %>%
  drop_na(p_crit_kpa) %>%
  drop_na(method)
ggplot(SalmonData, aes(x = temperature_c, y = p_crit_kpa, col = method)) +
  geom_point(size = 3) +
  xlab("Temperature (°C)") +
  ylab("Critical Oxygen (kPa)")

#filter out younger life stages
SalmonData <- SalmonData %>%
  filter(
    !tolower(life_stage_est) %in% c("egg", "early developmental stage") &
    !(method) %in% c("CardiacActivityControl", "BloodChemistry", "Exhaustion")
)
unique(SalmonData$life_stage_est)
#Use stefan boltzmann to standardize
kb <- 8.617333E-5
Tref <- 15
kelvin <- function(x) 273.15 + x
SalmonData$inverse_temperature <- 1  / kb * (1 / kelvin(SalmonData$temperature_c) - 1 / kelvin(Tref) )

#Plot inverse temperature vs log(Critical Oxygen) for Oncorhynchus
ggplot(SalmonData, aes(x = inverse_temperature, y = log(p_crit_kpa), col = method)) +
  geom_point(size = 3) +
  #geom_smooth(method = "lm", se = FALSE) + # trend lines for each color/genus
  xlab("Inverse Temperature (°C)") +
  ylab("log(Critical Oxygen) (kPa)") +
  ggtitle("Log of Critical Oxygen vs. Inverse Temperature for Oncorhynchus")
salmon_model <- lm(log(p_crit_kpa) ~ log(mean_mass_g_wet) + inverse_temperature + method, data = SalmonData )
summary(salmon_model)

#EUPHAUSIA
#Make data set of combed through data for Euphausia
#Speculating that collection locations in Antarctica (E. superba) have misleading data
EuphausiaData <- thedata %>%
  filter(genus == "Euphausia") %>%
  drop_na(p_crit_kpa) %>%
  drop_na(method)
ggplot(EuphausiaData, aes(x = temperature_c, y = p_crit_kpa, col = method)) +
  geom_point(size = 3) +
  xlab("Temperature (°C)") +
  ylab("Critical Oxygen (kPa)")

#Remove E. superba from data set
EuphausiaData <- thedata %>%
  filter(genus == "Euphausia") %>%
  drop_na(p_crit_kpa) %>%
  drop_na(method)
EuphausiaData <- EuphausiaData %>%
  filter(!(taxon) %in% c("E. superba"))
ggplot(EuphausiaData, aes(x = temperature_c, y = p_crit_kpa, col = method)) +
  geom_point(size = 3) +
  xlab("Inverse Temperature (°C)") +
  ylab("log(Critical Oxygen) (kPa)")
#Use stefan boltzman to standardize
kb <- 8.617333E-5
Tref <- 15
kelvin <- function(x) 273.15 + x
EuphausiaData$inverse_temperature <- 1  / kb * (1 / kelvin(EuphausiaData$temperature_c) - 1 / kelvin(Tref) )
#Plot inverse temperature vs log(Critical Oxygen) for Euphausia
ggplot(EuphausiaData, aes(x = inverse_temperature, y = log(p_crit_kpa), col = method)) +
  geom_point(size = 3) +
  #geom_smooth(method = "lm", se = FALSE) + # trend lines for each color/genus
  xlab("Inverse Temperature (°C)") +
  ylab("log(Critical Oxygen) (kPa)") +
  ggtitle("Log of Critical Oxygen vs. Inverse Temperature for Euphausia")
euphausia_model <- lm(log(p_crit_kpa) ~ inverse_temperature, data = EuphausiaData )
summary(euphausia_model)


#CLUPEA
ClupeaData <- thedata %>%
  filter(genus == "Clupea") %>%
  drop_na(p_crit_kpa) %>%
  drop_na(method)
ggplot(ClupeaData, aes(x = temperature_c, y = p_crit_kpa, col = method)) +
  geom_point(size = 3)


#CANCER
CancerData <- thedata %>%
  filter(genus == "Cancer") %>%
  drop_na(p_crit_kpa) %>%
  drop_na(method)
ggplot(CancerData, aes(x = temperature_c, y = p_crit_kpa, col = method)) +
  geom_point(size = 3) +
  xlab("Temperature (°C)") +
  ylab("Critical Oxygen (kPa)")
CancerData <- CancerData %>%
  filter(!life_stage_est %in% c("Developmental stage 3-4", "Developmental stage 5-6", "Developmental stage 7", "Developmental stage 8-9", "Developmental stage 10")) #filter out young crab
unique(CancerData$life_stage_est)
#Use stefan boltzmann to standardize
kb <- 8.617333E-5
Tref <- 15
kelvin <- function(x) 273.15 + x
CancerData$inverse_temperature <- 1  / kb * (1 / kelvin(CancerData$temperature_c) - 1 / kelvin(Tref) )

#Plot inverse temperature vs log(Critical Oxygen) for Cancer
ggplot(CancerData, aes(x = inverse_temperature, y = log(p_crit_kpa), col = method)) +
  geom_point(size = 3) +
  #geom_smooth(method = "lm", se = FALSE) + # trend lines for each color/genus
  xlab("Inverse Temperature (°C)") +
  ylab("log(Critical Oxygen) (kPa)") +
  ggtitle("Log of Critical Oxygen vs. Inverse Temperature for Cancer") 
 cancer_model <- lm(log(p_crit_kpa) ~ inverse_temperature + method, data = CancerData )
summary(cancer_model)



#Plot oxygen consumption vs temperature with body size colored salmon
SalmonData <- thedata %>%
  filter(genus == "Oncorhynchus") %>%
  drop_na(p_crit_kpa) %>%
  drop_na(med_mass_g_wet) %>%
  filter(med_mass_g_wet < 100)
ggplot(SalmonData, aes(x = temperature_c, y = p_crit_kpa, col = med_mass_g_wet)) +
  geom_point(size = 3) +
  xlab("Temperature (°C)") +
  ylab("Critical Oxygen (kPa)") +
  ggtitle("Critical Oxygen vs Temperature for Oncorhynchus")

#Plot critical oxygen vs temperature with method colored
CancerData <- thedata %>%
  filter(genus == "Cancer")
ggplot(CancerData, aes(x = temperature_c, y = p_crit_kpa, col = method)) +
  geom_point(size = 3) +
  xlab("Temperature (°C)") +
  ylab("Critical Oxygen (kPa)")
SalmonData <- SalmonData %>%
  filter(!tolower(life_stage_est) %in% c("egg", "early developmental stage")) #filter out young salmon
unique(SalmonData$life_stage_est)

#Graph of all values with filtered points
# temp vs pcrit with colors identifying genus
CancerData <- thedata %>%
  filter(genus == "Cancer") %>%
  drop_na(p_crit_kpa) %>%
  drop_na(method)
CancerData <- CancerData %>%
  filter(!life_stage_est %in% c("Developmental stage 3-4", "Developmental stage 5-6", "Developmental stage 7", "Developmental stage 8-9", "Developmental stage 10"))

EuphausiaData <- thedata %>%
  filter(genus == "Euphausia") %>%
  drop_na(p_crit_kpa) %>%
  drop_na(method)
EuphausiaData <- EuphausiaData %>%
  filter(!(taxon) %in% c("E. superba"))

SalmonData <- thedata %>%
  filter(genus == "Oncorhynchus") %>%
  drop_na(p_crit_kpa) %>%
  drop_na(method)
SalmonData <- SalmonData %>%
  filter(!tolower(life_stage_est) %in% c("egg", "early developmental stage"))

FilteredData <- bind_rows(SalmonData, CancerData, EuphausiaData)

ggplot(FilteredData, aes(x = (temperature_c), y = p_crit_kpa)) +
  geom_point(aes(col = genus)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # trend lines for each color/genus
  labs(
    title ="P_crit vs. Temperature",
    x ="Temperature (°C)",
    y ="Critical Oxygen Threshold (kPa)"
  )
view(SalmonData)



kb <- 8.617333E-5
Tref <- 15
kelvin <- function(x) 273.15 + x
FilteredData$inverse_temperature <- 1  / kb * (1 / kelvin(FilteredData$temperature_c) - 1 / kelvin(Tref) )
#Plot inverse temperature vs log(Critical Oxygen) for all
ggplot(FilteredData, aes(x = inverse_temperature, y = log(p_crit_kpa), col = genus)) +
  geom_point(size = 3) +
  #geom_smooth(method = "lm", se = FALSE) + # trend lines for each color/genus
  xlab("Inverse Temperature (°C)") +
  ylab("log(Critical Oxygen) (kPa)") +
  ggtitle("Log of Critical Oxygen vs. Inverse Temperature") 
filtereddata_model <- lm(log(p_crit_kpa) ~ log(med_mass_g_wet) + inverse_temperature + method, data = FilteredData )
summary(filtereddata_model)




#Import Buoy Data
BuoyData <- read.csv("~/Downloads/orca2_L1_profiles_aab0_40bb_9c33.csv")

BuoyData$sea_water_temperature <- as.numeric(BuoyData$sea_water_temperature) #convert to numeric
BuoyData$mass_concentration_of_oxygen_in_sea_water <- as.numeric(BuoyData$mass_concentration_of_oxygen_in_sea_water)
BuoyData$depth <- as.numeric(BuoyData$depth)
BuoyData$sea_water_practical_salinity <- as.numeric(BuoyData$sea_water_practical_salinity)
str(BuoyData)


#convert mg/L to kPa
source("~/Library/CloudStorage/OneDrive-Personal/EarthLab Internship/helper_funs.R")

BuoyData <- BuoyData[!is.na(BuoyData$mass_concentration_of_oxygen_in_sea_water), ]
mg_l_Buoyindex <- which(!is.na(BuoyData$mass_concentration_of_oxygen_in_sea_water))


BuoyData$oxygen_kpa[mg_l_Buoyindex] <- DO.unit.convert(x = BuoyData$mass_concentration_of_oxygen_in_sea_water[mg_l_Buoyindex],
                                                  DO.units.in = "mg/L",
                                                  DO.units.out = "PP",
                                                  bar.units.out = "kpa",
                                                  bar.press = 1,
                                                  bar.units.in = "atm",
                                                  salinity = BuoyData$sea_water_practical_salinity[mg_l_Buoyindex],
                                                  salinity.units = "uS",
                                                  temp.C = BuoyData$sea_water_temperature[mg_l_Buoyindex])

# create new column called inverse_temp
# drop all rows that do not list units

BuoyData <- drop_na(BuoyData, sea_water_temperature)
BuoyData$inverse_temp <- 1 / BuoyData$sea_water_temperature

#create new column for log(Oxygen)
BuoyData$ln_do <- log(BuoyData$oxygen_kpa)

#show summary
summary_BuoyData_new <- BuoyData %>%
  group_by(depth, sea_water_temperature, inverse_temp, ln_do, oxygen_kpa, mass_concentration_of_oxygen_in_sea_water) %>%
  summarise(number = n())

View(summary_BuoyData_new)

#time
BuoyData$time <- as.POSIXct(BuoyData$time, format = "%Y-%m-%dT%H:%M:%OSZ", tz = "UTC")
BuoyData$date <- as.Date(BuoyData$time)

library(dplyr)

Buoy7am <- BuoyData %>%
  filter(format(time, "%H:%M") == "07:00")

target_depths <- c(2, 4, 6, 8, 10, 20, 30, 50, 75, 100, 115)

BuoySubset <- data.frame()
for (current_date in unique(Buoy7am$date)) {
  day_data <- Buoy7am[Buoy7am$date == current_date, ]
  for (target_depth in target_depths) {
    depth_diff <- abs(day_data$depth - target_depth)
    min_index <- which.min(depth_diff)
    
    closest_row <- day_data[min_index, ]
    closest_row$depth_target <- target_depth
    BuoySubset <- rbind(BuoySubset, closest_row)
  }
}

nrow(BuoySubset) #check, should be around 60

#Plot Buoy Data
 ggplot(BuoySubset, aes(x = inverse_temp, y = ln_do, color = depth_target)) +
  geom_point(size = 3) +
  #facet_wrap(~ date) +
  scale_color_viridis_c(name = "Depth (m)", guide = guide_colorbar(reverse=TRUE)) +
  labs(
    x = "Inverse Temperature (1/°C)",
    y = "ln(Oxygen Concentration) (kPa)",
    title = "ln(Oxygen Concentration) vs Inverse Temp at about 07:00"
  ) +
  theme_minimal()


#Now overlap buoy data with Oncorhynchus literature data (need new line of best fit for this to work)

ggplot(SalmonData, aes(x = inverse_temperature, y = log(p_crit_kpa))) +
  #geom_point(size = 3, color = "steelblue") +
  geom_smooth(method="lm", se = FALSE, color = "steelblue") +
  geom_point(
    data = BuoySubset,
    aes(x = inverse_temp, y = ln_do, color = depth_target)
  ) +
  scale_color_viridis_c(name = "Depth (m)", guide = guide_colorbar(reverse=TRUE)) +
  xlab("Inverse Temperature (1/°C)") +
  ylab("log(Oxygen Pressure) (kPa)") +
  ggtitle("Oncorhynchus Critical Oxygen Compared to Hood Canal Environmental Oxygen with Depth (September 2023)") +
  theme_minimal()


